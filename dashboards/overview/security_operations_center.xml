<dashboard version="1.1" theme="dark">
  <label>Security Operations Center Overview</label>
  <description>Executive dashboard for security posture and operational metrics</description>
  
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  
  <!-- Key Metrics Row -->
  <row>
    <panel>
      <title>Security Alerts</title>
      <single>
        <search>
          <query>
            `security_indexes` severity IN ("critical","high")
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
      </single>
    </panel>
    <panel>
      <title>Failed Authentications</title>
      <single>
        <search>
          <query>
            | datamodel Authentication search
            | search action=failure
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
      </single>
    </panel>
    <panel>
      <title>Malware Detections</title>
      <single>
        <search>
          <query>
            | datamodel Malware search
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
      </single>
    </panel>
    <panel>
      <title>Network Blocks</title>
      <single>
        <search>
          <query>
            | datamodel Network_Traffic search
            | search action=blocked
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option> 
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
      </single>
    </panel>
  </row>
  
  <!-- Threat Intelligence Row -->
  <row>
    <panel>
      <title>Top Threat Sources</title>
      <table>
        <search>
          <query>
            `security_indexes`
            | lookup threat_indicators threat_indicator AS src_ip OUTPUTNEW threat_type, confidence
            | where isnotnull(threat_type)
            | stats count by src_ip, threat_type, confidence
            | lookup geoip_lookup ip AS src_ip OUTPUTNEW country, city
            | fillnull value="unknown" country, city
            | sort -count
            | head 10
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <format type="color" field="confidence">
          <colorPalette type="list">[#DC4E41,#F1813F,#F8BE34,#53A051]</colorPalette>
          <scale type="threshold">low,medium,high</scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Attack Categories</title>
      <chart>
        <search>
          <query>
            `security_indexes` tag=attack
            | stats count by category
            | sort -count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
  
  <!-- Activity Trends Row -->
  <row>
    <panel>
      <title>Security Event Trends</title>
      <chart>
        <search>
          <query>
            `security_indexes`
            | bucket _time span=1h
            | eval event_category=case(
                tag="authentication","Authentication",
                tag="network","Network", 
                tag="malware","Malware",
                tag="web","Web",
                tag="email","Email",
                1=1,"Other"
            )
            | stats count by _time, event_category
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Event Count</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>
  
  <!-- Geographic and Risk Analysis -->
  <row>
    <panel>
      <title>Geographic Threat Distribution</title>
      <map>
        <search>
          <query>
            `security_indexes` tag=attack `external_networks`
            | stats count by src_ip
            | lookup geoip_lookup ip AS src_ip OUTPUTNEW lat, lon, country
            | where isnotnull(lat) AND isnotnull(lon)
            | geostats latfield=lat longfield=lon count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="mapping.type">marker</option>
        <option name="mapping.markerSize">medium</option>
      </map>
    </panel>
    <panel>
      <title>Risk Score Distribution</title>
      <chart>
        <search>
          <query>
            `security_indexes`
            | eval risk_score=case(
                severity="critical",100,
                severity="high",75,
                severity="medium",50,
                severity="low",25,
                1=1,10
            )
            | lookup asset_inventory ip AS dest_ip OUTPUTNEW criticality
            | eval adjusted_risk=if(criticality="critical",risk_score*1.5,risk_score)
            | stats avg(adjusted_risk) as avg_risk by asset_type
            | sort -avg_risk
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Asset Type</option>
        <option name="charting.axisTitleY.text">Average Risk Score</option>
      </chart>
    </panel>
  </row>
  
  <!-- Detailed Analysis Row -->
  <row>
    <panel>
      <title>High-Risk User Activity</title>
      <table>
        <search>
          <query>
            | datamodel Authentication search
            | search `after_hours` OR `high_risk_countries`
            | stats count, dc(dest) as unique_systems, dc(src_ip) as unique_sources by user
            | where count > 10 OR unique_systems > 5
            | eval risk_indicators=count + (unique_systems*2) + (unique_sources*1.5)
            | sort -risk_indicators
            | head 15
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <format type="color" field="risk_indicators">
          <colorPalette type="list">[#53A051,#F8BE34,#F1813F,#DC4E41]</colorPalette>
          <scale type="threshold">10,25,50</scale>
        </format>
        <drilldown>
          <link target="_blank">/app/search/search?q=| datamodel Authentication search | search user="$row.user$" | table _time, src_ip, dest, action, app</link>
        </drilldown>
      </table>
    </panel>
  </row>
</dashboard>