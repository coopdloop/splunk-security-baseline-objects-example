<dashboard version="1.1" theme="light">
  <label>Network Anomaly Detection</label>
  <description>Detect suspicious network patterns and anomalies for proactive threat hunting</description>
  
  <fieldset submitButton="true" autoRun="false">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="network_index">
      <label>Network Data Source</label>
      <choice value="*">All Network Data</choice>
      <choice value="firewall">Firewall</choice>
      <choice value="ids">IDS/IPS</choice>
      <choice value="proxy">Proxy Logs</choice>
      <default>*</default>
    </input>
  </fieldset>
  
  <row>
    <panel>
      <title>Rare Network Connections</title>
      <table>
        <search>
          <query>
            | datamodel Network_Traffic search
            | search index=$network_index$
            | stats count by src_ip, dest_ip, dest_port
            | where count &lt; 5
            | lookup threat_indicators threat_indicator AS src_ip OUTPUTNEW threat_type AS src_threat
            | lookup threat_indicators threat_indicator AS dest_ip OUTPUTNEW threat_type AS dest_threat  
            | lookup asset_inventory ip AS src_ip OUTPUTNEW asset_type AS src_asset, criticality AS src_criticality
            | lookup asset_inventory ip AS dest_ip OUTPUTNEW asset_type AS dest_asset, criticality AS dest_criticality
            | fillnull value="unknown" src_threat, dest_threat, src_asset, dest_asset, src_criticality, dest_criticality
            | sort -count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <drilldown>
          <link target="_blank">/app/search/search?q=| datamodel Network_Traffic search | search src_ip="$row.src_ip$" dest_ip="$row.dest_ip$" | table _time, src_port, action, bytes</link>
        </drilldown>
      </table>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Suspicious Port Usage</title>
      <chart>
        <search>
          <query>
            | datamodel Network_Traffic search  
            | search index=$network_index$ dest_port IN (4444,5555,6666,7777,8888,9999,1337,31337)
            | stats count by dest_port, action
            | eval risk_level=case(dest_port IN (4444,6666,1337,31337),"high",1=1,"medium")
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Destination Port</option>
        <option name="charting.axisTitleY.text">Connection Count</option>
      </chart>
    </panel>
    <panel>
      <title>DNS Tunneling Detection</title>
      <table>
        <search>
          <query>
            index=$network_index$ sourcetype=dns
            | stats count, dc(answer) as unique_answers, avg(len(query)) as avg_query_length by query
            | where unique_answers > 10 AND avg_query_length > 50
            | eval suspicion_score=round((unique_answers * avg_query_length)/100,2)
            | sort -suspicion_score
            | head 20
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
      </table>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Data Exfiltration Indicators</title>
      <table>
        <search>
          <query>
            | datamodel Network_Traffic search
            | search index=$network_index$ `external_networks`
            | stats sum(bytes_out) as total_out, sum(bytes_in) as total_in by src_ip, dest_ip
            | where total_out > 100000000
            | eval out_in_ratio=round(total_out/total_in,2)
            | lookup asset_inventory ip AS src_ip OUTPUTNEW hostname, asset_type, criticality, owner
            | fillnull value="unknown" hostname, asset_type, criticality, owner
            | sort -total_out
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <format type="color" field="total_out">
          <colorPalette type="list">[#53A051,#F8BE34,#F1813F,#DC4E41]</colorPalette>
          <scale type="threshold">10000000,50000000,100000000</scale>
        </format>
      </table>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Network Activity Timeline</title>
      <chart>
        <search>
          <query>
            | datamodel Network_Traffic search
            | search index=$network_index$
            | bucket _time span=1h
            | stats count by _time, action
            | eval hour=strftime(_time,"%H")
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Connection Count</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>
</dashboard>