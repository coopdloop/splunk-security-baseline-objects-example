# Threat Hunting Saved Searches

[TH - Rare Process Execution]
search = index=endpoint sourcetype=sysmon EventCode=1 \
| rare Image limit=20 \
| where count < 5 AND probability < 0.01 \
| lookup threat_indicators threat_indicator AS CommandLine OUTPUTNEW threat_type \
| fillnull value="unknown" threat_type

description = Identifies rarely executed processes that may indicate malware or unauthorized tools
dispatch.earliest_time = -24h
dispatch.latest_time = now
cron_schedule = 0 */4 * * *
enableSched = 1

[TH - Suspicious Network Beaconing]
search = | datamodel Network_Traffic search \
| bucket _time span=5m \
| stats count by _time, src_ip, dest_ip \
| eventstats avg(count) as avg_connections, stdev(count) as stdev_connections by src_ip, dest_ip \
| where count > (avg_connections + (2*stdev_connections)) \
| lookup asset_inventory ip AS src_ip OUTPUTNEW asset_type, criticality

description = Detects potential C2 beaconing through statistical analysis of network connections
dispatch.earliest_time = -4h
dispatch.latest_time = now
cron_schedule = 0 */2 * * *
enableSched = 1

[TH - Anomalous Authentication Patterns]
search = | datamodel Authentication search \
| eval hour=strftime(_time,"%H") \
| stats count by user, hour \
| eventstats avg(count) as avg_hourly, stdev(count) as stdev_hourly by user \
| where count > (avg_hourly + (3*stdev_hourly)) \
| lookup asset_inventory hostname AS dest OUTPUTNEW criticality

description = Identifies users with unusual authentication timing patterns
dispatch.earliest_time = -7d
dispatch.latest_time = now
cron_schedule = 0 6 * * *
enableSched = 1

[TH - Lateral Movement Detection]
search = | datamodel Authentication search \
| search action=success \
| bucket _time span=15m \
| stats dc(dest) as unique_systems by _time, user \
| where unique_systems > 5 \
| lookup threat_indicators threat_indicator AS user OUTPUTNEW threat_type

description = Detects potential lateral movement through rapid authentication to multiple systems
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1
alert.track = 1

[TH - DNS Exfiltration Detection]
search = index=network sourcetype=dns \
| stats count, dc(answer) as unique_answers, avg(len(query)) as avg_length by query \
| where unique_answers > 10 AND avg_length > 50 \
| eval suspicion_score=round((unique_answers * avg_length)/100,2) \
| where suspicion_score > 20

description = Identifies potential DNS tunneling and exfiltration activities
dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = */30 * * * *
enableSched = 1

[TH - Privilege Escalation Attempts]
search = `security_indexes` tag=privileged \
| search (action=success AND previous_privilege!=current_privilege) OR (EventCode=4672 OR EventCode=4648) \
| stats count by user, dest, privilege_escalation_type \
| lookup asset_inventory hostname AS dest OUTPUTNEW criticality \
| where criticality="critical"

description = Monitors for successful privilege escalation on critical systems
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1
alert.track = 1

[TH - Suspicious File Hash Activity]
search = | datamodel Malware search \
| lookup threat_indicators threat_indicator AS file_hash OUTPUTNEW threat_type, confidence \
| where isnotnull(threat_type) \
| stats count, values(dest) as affected_hosts by file_hash, signature, threat_type \
| sort -count

description = Correlates file hashes with threat intelligence for malware detection
dispatch.earliest_time = -30m
dispatch.latest_time = now
cron_schedule = */30 * * * *
enableSched = 1

[TH - Web Attack Correlation]
search = | datamodel Web search \
| search tag=attack \
| stats count, dc(src_ip) as unique_attackers by uri_path, http_method \
| where count > 10 AND unique_attackers > 3 \
| lookup threat_indicators threat_indicator AS uri_path OUTPUTNEW threat_type

description = Identifies coordinated web attacks across multiple source IPs
dispatch.earliest_time = -2h
dispatch.latest_time = now
cron_schedule = 0 */2 * * *
enableSched = 1

[TH - Insider Threat Indicators]
search = | datamodel Authentication search \
| search `after_hours` action=success \
| lookup asset_inventory hostname AS dest OUTPUTNEW criticality \
| where criticality IN ("critical","high") \
| stats count, dc(dest) as systems_accessed by user \
| where count > 20 OR systems_accessed > 10

description = Monitors for potential insider threat activities during off-hours
dispatch.earliest_time = -24h
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1