# Security-focused search macros

[security_indexes]
definition = (index=security OR index=firewall OR index=ids OR index=av OR index=proxy)

[business_hours]
definition = (date_hour>=8 AND date_hour<=17 AND date_wday>=2 AND date_wday<=6)

[after_hours] 
definition = NOT (date_hour>=8 AND date_hour<=17 AND date_wday>=2 AND date_wday<=6)

[high_risk_countries]
definition = (src_country IN ("CN","RU","IR","KP","SY") OR dest_country IN ("CN","RU","IR","KP","SY"))

[internal_networks]
definition = (cidrmatch("192.168.0.0/16",src_ip) OR cidrmatch("10.0.0.0/8",src_ip) OR cidrmatch("172.16.0.0/12",src_ip))

[external_networks]
definition = NOT (cidrmatch("192.168.0.0/16",src_ip) OR cidrmatch("10.0.0.0/8",src_ip) OR cidrmatch("172.16.0.0/12",src_ip))

[suspicious_file_extensions]
definition = (file_ext IN ("exe","scr","bat","ps1","vbs","jar","com","pif"))

[web_attacks]
definition = (http_method IN ("POST","PUT","DELETE") AND (status>=400 OR uri_path="*../*" OR uri_query="*script*"))

[failed_authentication]
definition = (tag=authentication action=failure)

[successful_authentication] 
definition = (tag=authentication action=success)

[critical_assets]
definition = (asset_category="critical" OR asset_type IN ("domain_controller","database_server","security_device"))

# Parameterized macros
[user_activity(1)]
args = username
definition = `security_indexes` user="$username$" | stats count by _time, action, src_ip, dest

[ip_reputation(1)]
args = ip_address  
definition = | lookup threat_indicators threat_indicator AS $ip_address$ | eval reputation=if(isnull(threat_type),"clean","malicious")

[timeframe_stats(2)]
args = timespan,field
definition = | bucket _time span=$timespan$ | stats count by _time, $field$ | sort _time